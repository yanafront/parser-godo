import OpenAI from 'openai';
import dotenv from "dotenv";

dotenv.config();

const client = new OpenAI({
  apiKey: process.env.OPENAI_API_KEY,
});

export async function sendMessage(text: string) : Promise<string>{
  try {
    console.log(`ü§ñ –û—Ç–ø—Ä–∞–≤–ª—è—é –≤ OpenAI:`, text.substring(0, 100) + (text.length > 100 ? '...' : ''));
    
    const response = await client.chat.completions.create({
      model: 'gpt-3.5-turbo',
      messages: [
        {
          role: 'system',
          content: `–ö–†–ò–¢–ò–ß–ï–°–ö–ò –í–ê–ñ–ù–û: –æ—Ç–≤–µ—á–∞–π –°–¢–†–û–ì–û –æ–¥–Ω–æ–π —Å—Ç—Ä–æ–∫–æ–π –≤ —Ñ–æ—Ä–º–∞—Ç–µ JSON.

–§–æ—Ä–º–∞—Ç: {"phone": "–∫–æ–Ω—Ç–∞–∫—Ç", "message": "—Ç–µ–∫—Å—Ç –≤–∞–∫–∞–Ω—Å–∏–∏"}

–ü—Ä–∞–≤–∏–ª–∞ —Ñ–æ—Ä–º–∞—Ç–∏—Ä–æ–≤–∞–Ω–∏—è —Å–æ–æ–±—â–µ–Ω–∏—è (–ï–î–ò–ù–´–ô –°–¢–ò–õ–¨):
1) –ï—Å–ª–∏ —ç—Ç–æ –Ω–µ –≤–∞–∫–∞–Ω—Å–∏—è: {"phone": "", "message": "–ù–µ –≤–∞–∫–∞–Ω—Å–∏—è"}
2) –í–°–ï–ì–î–ê –∏—Å–ø–æ–ª—å–∑—É–π –ï–î–ò–ù–û–û–ë–†–ê–ó–ù–£–Æ —Å—Ç—Ä—É–∫—Ç—É—Ä—É –∏ –ø–æ—Ä—è–¥–æ–∫ –ø–æ–ª–µ–π.
3) –ü–æ—Ä—è–¥–æ–∫ –ø–æ–ª–µ–π (–∏—Å–ø–æ–ª—å–∑—É–π —Ç–æ–ª—å–∫–æ —Ç–µ, –¥–ª—è –∫–æ—Ç–æ—Ä—ã—Ö –µ—Å—Ç—å –¥–∞–Ω–Ω—ã–µ):
   - <b>üíº –î–æ–ª–∂–Ω–æ—Å—Ç—å/–ü–æ–¥—Ä–∞–±–æ—Ç–∫–∞</b> (–æ–±—è–∑–∞—Ç–µ–ª—å–Ω–æ, –Ω–∞–∑–≤–∞–Ω–∏–µ –¥–æ–ª–∂–Ω–æ—Å—Ç–∏)
   - <b>üè¢ –ö–æ–º–ø–∞–Ω–∏—è:</b> (–µ—Å–ª–∏ —É–∫–∞–∑–∞–Ω–∞)
   - <b>üìç –ê–¥—Ä–µ—Å:</b> (–µ—Å–ª–∏ —É–∫–∞–∑–∞–Ω)
   - <b>üìÖ –î–∞—Ç–∞/–ì—Ä–∞—Ñ–∏–∫:</b> (–µ—Å–ª–∏ —É–∫–∞–∑–∞–Ω–æ)
   - <b>‚è∞ –í—Ä–µ–º—è —Ä–∞–±–æ—Ç—ã:</b> (–µ—Å–ª–∏ —É–∫–∞–∑–∞–Ω–æ)
   - <b>‚öôÔ∏è –£—Å–ª–æ–≤–∏—è:</b> (–µ—Å–ª–∏ —É–∫–∞–∑–∞–Ω—ã)
   - <b>üìã –û–±—è–∑–∞–Ω–Ω–æ—Å—Ç–∏:</b> (–µ—Å–ª–∏ —É–∫–∞–∑–∞–Ω—ã)
   - <b>‚úîÔ∏è –¢—Ä–µ–±–æ–≤–∞–Ω–∏—è:</b> (–µ—Å–ª–∏ —É–∫–∞–∑–∞–Ω—ã)
   - <b>üí∞ –û–ø–ª–∞—Ç–∞:</b> (–µ—Å–ª–∏ —É–∫–∞–∑–∞–Ω–∞)
   - <b>üìû –ö–æ–Ω—Ç–∞–∫—Ç—ã:</b> (–µ—Å–ª–∏ —É–∫–∞–∑–∞–Ω—ã)

4) –§–æ—Ä–º–∞—Ç–∏—Ä–æ–≤–∞–Ω–∏–µ:
   - –ó–∞–≥–æ–ª–æ–≤–∫–∏: <b>—ç–º–æ–¥–∑–∏ –ó–∞–≥–æ–ª–æ–≤–æ–∫:</b> (—Å –¥–≤–æ–µ—Ç–æ—á–∏–µ–º –ø–æ—Å–ª–µ –∑–∞–≥–æ–ª–æ–≤–∫–∞)
   - –¢–µ–∫—Å—Ç –ø–æ—Å–ª–µ –∑–∞–≥–æ–ª–æ–≤–∫–∞: –æ–±—ã—á–Ω—ã–π —Ç–µ–∫—Å—Ç, –±–µ–∑ —Ñ–æ—Ä–º–∞—Ç–∏—Ä–æ–≤–∞–Ω–∏—è
   - –≠–º–æ–¥–∑–∏ –¢–û–õ–¨–ö–û –≤ –∑–∞–≥–æ–ª–æ–≤–∫–∞—Ö
   - –û–¥–∏–Ω –±–ª–æ–∫ –Ω–∞ —Å—Ç—Ä–æ–∫—É —á–µ—Ä–µ–∑ \\n

5) –¢–µ–º–∞—Ç–∏—á–µ—Å–∫–∏–µ —ç–º–æ–¥–∑–∏ –¥–ª—è –∑–∞–≥–æ–ª–æ–≤–∫–æ–≤:
   - üíº –¥–ª—è –î–æ–ª–∂–Ω–æ—Å—Ç–∏/–ü–æ–¥—Ä–∞–±–æ—Ç–∫–∏
   - üè¢ –¥–ª—è –ö–æ–º–ø–∞–Ω–∏–∏
   - üìÖ –¥–ª—è –î–∞—Ç–∞/–ì—Ä–∞—Ñ–∏–∫
   - üìç –¥–ª—è –ê–¥—Ä–µ—Å–∞
   - ‚è∞ –¥–ª—è –í—Ä–µ–º–µ–Ω–∏ —Ä–∞–±–æ—Ç—ã
   - ‚öôÔ∏è –¥–ª—è –£—Å–ª–æ–≤–∏–π
   - üìã –¥–ª—è –û–±—è–∑–∞–Ω–Ω–æ—Å—Ç–µ–π
   - ‚úîÔ∏è –¥–ª—è –¢—Ä–µ–±–æ–≤–∞–Ω–∏–π
   - üí∞ –¥–ª—è –û–ø–ª–∞—Ç—ã
   - üìû –¥–ª—è –ö–æ–Ω—Ç–∞–∫—Ç–æ–≤

6) –ü–µ—Ä–µ–Ω–æ—Å—ã —Å—Ç—Ä–æ–∫ –≤ –ø–æ–ª–µ message —Ç–æ–ª—å–∫–æ —á–µ—Ä–µ–∑ \\n.
7) –ù–∏–∫–∞–∫–æ–≥–æ —Ç–µ–∫—Å—Ç–∞ –∫—Ä–æ–º–µ JSON.

–ü—Ä–∏–º–µ—Ä –ï–î–ò–ù–û–û–ë–†–ê–ó–ù–û–ì–û —Ñ–æ—Ä–º–∞—Ç–∞:
{"phone": "+375291234567", "message": "<b>üíº –ü—Ä–æ–¥–∞–≤–µ—Ü-–∫–æ–Ω—Å—É–ª—å—Ç–∞–Ω—Ç</b>\\n<b>üè¢ –ö–æ–º–ø–∞–Ω–∏—è:</b> –í–ï–ô–ü –®–û–ü\\n<b>üìç –ê–¥—Ä–µ—Å:</b> –ú–∏–Ω—Å–∫, —É–ª. –õ–µ–Ω–∏–Ω–∞, 1\\n<b>üìÖ –ì—Ä–∞—Ñ–∏–∫:</b> 2/2\\n<b>‚öôÔ∏è –£—Å–ª–æ–≤–∏—è:</b> —Å—Ç–∞–∂–∏—Ä–æ–≤–∫–∞, –æ—Ñ–∏—Ü–∏–∞–ª—å–Ω–æ–µ —Ç—Ä—É–¥–æ—É—Å—Ç—Ä–æ–π—Å—Ç–≤–æ\\n<b>‚úîÔ∏è –¢—Ä–µ–±–æ–≤–∞–Ω–∏—è:</b> —É–º–µ–Ω–∏–µ –ø—Ä–æ–¥–∞–≤–∞—Ç—å, —Ä–∞–±–æ—Ç–∞ —Å –∫–∞—Å—Å–æ–π, –≥—Ä–∞–º–æ—Ç–Ω–∞—è —Ä–µ—á—å\\n<b>üí∞ –û–ø–ª–∞—Ç–∞:</b> –æ—Ç 1200 BYN\\n<b>üìû –ö–æ–Ω—Ç–∞–∫—Ç—ã:</b> +375291234567"}`
        },
        {
          role: 'user',
          content: text
        }
      ],
      temperature: 0.7,
    });

    const result = response.choices[0].message.content || "–ù–µ –≤–∞–∫–∞–Ω—Å–∏—è";
    console.log(`ü§ñ OpenAI –æ—Ç–≤–µ—Ç–∏–ª:`, result);
    return result;
  } catch (error) {
    console.error(`‚ùå –û—à–∏–±–∫–∞ OpenAI:`, error);
    return "–ù–µ –≤–∞–∫–∞–Ω—Å–∏—è";
  }
}