import OpenAI from 'openai';
import dotenv from "dotenv";

dotenv.config();

const client = new OpenAI({
  apiKey: process.env.OPENAI_API_KEY,
});

export async function sendMessage(text: string) : Promise<string>{
  try {
    console.log(`ü§ñ –û—Ç–ø—Ä–∞–≤–ª—è—é –≤ OpenAI:`, text.substring(0, 100) + (text.length > 100 ? '...' : ''));
    
    const response = await client.chat.completions.create({
      model: 'gpt-3.5-turbo',
      messages: [
        {
          role: 'system',
          content: `–ö–†–ò–¢–ò–ß–ï–°–ö–ò –í–ê–ñ–ù–û: –æ—Ç–≤–µ—á–∞–π –°–¢–†–û–ì–û –æ–¥–Ω–æ–π —Å—Ç—Ä–æ–∫–æ–π –≤ —Ñ–æ—Ä–º–∞—Ç–µ JSON.

–§–æ—Ä–º–∞—Ç: {"phone": "–∫–æ–Ω—Ç–∞–∫—Ç", "message": "—Ç–µ–∫—Å—Ç –≤–∞–∫–∞–Ω—Å–∏–∏"}

–ü—Ä–∞–≤–∏–ª–∞ —Ñ–æ—Ä–º–∞—Ç–∏—Ä–æ–≤–∞–Ω–∏—è —Å–æ–æ–±—â–µ–Ω–∏—è:
1) –ï—Å–ª–∏ —ç—Ç–æ –Ω–µ –≤–∞–∫–∞–Ω—Å–∏—è: {"phone": "", "message": "–ù–µ –≤–∞–∫–∞–Ω—Å–∏—è"}
2) –í–∫–ª—é—á–∞–π –¢–û–õ–¨–ö–û —Ç–µ –±–ª–æ–∫–∏, –ø–æ –∫–æ—Ç–æ—Ä—ã–º –Ω–∞–π–¥–µ–Ω—ã –¥–∞–Ω–Ω—ã–µ. –ù–∏–∫–æ–≥–¥–∞ –Ω–µ –≤—ã–≤–æ–¥–∏ –ø—É—Å—Ç—ã–µ –ø–æ–ª—è.
3) –ò—Å–ø–æ–ª—å–∑—É–π —Ä—É—Å—Å–∫–∏–µ –∑–∞–≥–æ–ª–æ–≤–∫–∏: –ü–æ–¥—Ä–∞–±–æ—Ç–∫–∞/–î–æ–ª–∂–Ω–æ—Å—Ç—å, –ö–æ–º–ø–∞–Ω–∏—è, –î–∞—Ç–∞, –ê–¥—Ä–µ—Å, –í—Ä–µ–º—è, –£—Å–ª–æ–≤–∏—è, –û–±—è–∑–∞–Ω–Ω–æ—Å—Ç–∏, –¢—Ä–µ–±–æ–≤–∞–Ω–∏—è, –û–ø–ª–∞—Ç–∞, –ö–æ–Ω—Ç–∞–∫—Ç—ã. –†–∞–∑—Ä–µ—à–µ–Ω—ã —ç–º–æ–¥–∑–∏ –∏ <b>–∂–∏—Ä–Ω—ã–π</b>.
4) –ü–µ—Ä–µ–Ω–æ—Å—ã —Å—Ç—Ä–æ–∫ –≤ –ø–æ–ª–µ message —Ç–æ–ª—å–∫–æ —á–µ—Ä–µ–∑ \\n.
5) –ù–∏–∫–∞–∫–æ–≥–æ —Ç–µ–∫—Å—Ç–∞ –∫—Ä–æ–º–µ JSON.

–ü—Ä–∏–º–µ—Ä —Ñ–æ—Ä–º–∞—Ç–∞ (–ø–æ–ª—è –≥–∏–±–∫–∏–µ –∏ –º–æ–≥—É—Ç –æ—Ç—Å—É—Ç—Å—Ç–≤–æ–≤–∞—Ç—å):
{"phone": "+375291234567", "message": "–ü—Ä–æ–¥–∞–≤–µ—Ü-–∫–æ–Ω—Å—É–ª—å—Ç–∞–Ω—Ç\\n–ö–æ–º–ø–∞–Ω–∏—è: –í–ï–ô–ü –®–û–ü\\n–£—Å–ª–æ–≤–∏—è: —Å—Ç–∞–∂–∏—Ä–æ–≤–∫–∞, –æ—Ñ–∏—Ü–∏–∞–ª—å–Ω–æ–µ —Ç—Ä—É–¥–æ—É—Å—Ç—Ä–æ–π—Å—Ç–≤–æ, –≥—Ä–∞—Ñ–∏–∫ 2/2\\n–¢—Ä–µ–±–æ–≤–∞–Ω–∏—è: —É–º–µ–Ω–∏–µ –ø—Ä–æ–¥–∞–≤–∞—Ç—å, —Ä–∞–±–æ—Ç–∞ —Å –∫–∞—Å—Å–æ–π –∏ —Ç–µ—Ä–º–∏–Ω–∞–ª–æ–º, –≥—Ä–∞–º–æ—Ç–Ω–∞—è —Ä–µ—á—å\\n–û–ø–ª–∞—Ç–∞: –æ—Ç 1200 BYN\\n–ö–æ–Ω—Ç–∞–∫—Ç—ã: +375291234567"}`
        },
        {
          role: 'user',
          content: text
        }
      ],
      temperature: 0.7,
    });

    const result = response.choices[0].message.content || "–ù–µ –≤–∞–∫–∞–Ω—Å–∏—è";
    console.log(`ü§ñ OpenAI –æ—Ç–≤–µ—Ç–∏–ª:`, result);
    return result;
  } catch (error) {
    console.error(`‚ùå –û—à–∏–±–∫–∞ OpenAI:`, error);
    return "–ù–µ –≤–∞–∫–∞–Ω—Å–∏—è";
  }
}