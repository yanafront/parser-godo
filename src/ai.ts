import OpenAI from 'openai';
import dotenv from "dotenv";

dotenv.config();

const client = new OpenAI({
  apiKey: process.env.OPENAI_API_KEY,
});

export async function sendMessage(text: string) : Promise<string>{
  try {
    console.log(`ü§ñ –û—Ç–ø—Ä–∞–≤–ª—è—é –≤ OpenAI:`, text.substring(0, 100) + (text.length > 100 ? '...' : ''));
    
    const response = await client.chat.completions.create({
      model: 'gpt-3.5-turbo',
      messages: [
        {
          role: 'system',
          content: `–¢—ã - —ç–∫—Å–ø–µ—Ä—Ç –ø–æ —Ñ–æ—Ä–º–∞—Ç–∏—Ä–æ–≤–∞–Ω–∏—é –≤–∞–∫–∞–Ω—Å–∏–π –¥–ª—è Telegram –∫–∞–Ω–∞–ª–∞. –¢–≤–æ—è –∑–∞–¥–∞—á–∞:

1. –ü—Ä–æ–∞–Ω–∞–ª–∏–∑–∏—Ä–æ–≤–∞—Ç—å —Å–æ–æ–±—â–µ–Ω–∏–µ –∏ –æ–ø—Ä–µ–¥–µ–ª–∏—Ç—å, —è–≤–ª—è–µ—Ç—Å—è –ª–∏ –æ–Ω–æ –≤–∞–∫–∞–Ω—Å–∏–µ–π
2. –ï—Å–ª–∏ —ç—Ç–æ –≤–∞–∫–∞–Ω—Å–∏—è - –æ—Ç—Ñ–æ—Ä–º–∞—Ç–∏—Ä–æ–≤–∞—Ç—å –µ—ë –≤ –µ–¥–∏–Ω–æ–º —Å—Ç–∏–ª–µ –¥–ª—è –ø—É–±–ª–∏–∫–∞—Ü–∏–∏
3. –ï—Å–ª–∏ –Ω–µ –≤–∞–∫–∞–Ω—Å–∏—è - –æ—Ç–≤–µ—Ç–∏—Ç—å "–ù–µ –≤–∞–∫–∞–Ω—Å–∏—è"

–§–æ—Ä–º–∞—Ç –æ—Ç–≤–µ—Ç–∞: {"phone": "{{PHONE}}", "message": "{{MESSAGE}}"}

–¢—Ä–µ–±–æ–≤–∞–Ω–∏—è –∫ —Ñ–æ—Ä–º–∞—Ç–∏—Ä–æ–≤–∞–Ω–∏—é –≤–∞–∫–∞–Ω—Å–∏–∏:
- –ò—Å–ø–æ–ª—å–∑—É–π HTML —Ç–µ–≥–∏ –¥–ª—è –∫—Ä–∞—Å–∏–≤–æ–≥–æ –æ—Ñ–æ—Ä–º–ª–µ–Ω–∏—è
- –°—Ç—Ä—É–∫—Ç—É—Ä–∞: <b>–î–æ–ª–∂–Ω–æ—Å—Ç—å</b>, <b>–ö–æ–º–ø–∞–Ω–∏—è</b>, <b>–ó–∞—Ä–ø–ª–∞—Ç–∞</b>, <b>–¢—Ä–µ–±–æ–≤–∞–Ω–∏—è</b>, <b>–ö–æ–Ω—Ç–∞–∫—Ç—ã</b>
- –î–æ–±–∞–≤—å —ç–º–æ–¥–∑–∏ –¥–ª—è –ø—Ä–∏–≤–ª–µ—á–µ–Ω–∏—è –≤–Ω–∏–º–∞–Ω–∏—è: üíº üè¢ üí∞ üìã üìû
- –°–¥–µ–ª–∞–π —Ç–µ–∫—Å—Ç —á–∏—Ç–∞–µ–º—ã–º –∏ –ø—Ä–æ—Ñ–µ—Å—Å–∏–æ–Ω–∞–ª—å–Ω—ã–º
- –£–±–µ—Ä–∏ –ª–∏—à–Ω—é—é –∏–Ω—Ñ–æ—Ä–º–∞—Ü–∏—é –∏ –æ—Å—Ç–∞–≤—å —Ç–æ–ª—å–∫–æ —Å—É—Ç—å
- –ï—Å–ª–∏ –∏–Ω—Ñ–æ—Ä–º–∞—Ü–∏–∏ –º–∞–ª–æ - –¥–æ–±–∞–≤—å "–£—Ç–æ—á–Ω—è–π—Ç–µ –¥–µ—Ç–∞–ª–∏"

–ü—Ä–∏–º–µ—Ä —Ö–æ—Ä–æ—à–µ–≥–æ —Ñ–æ—Ä–º–∞—Ç–∏—Ä–æ–≤–∞–Ω–∏—è:
üíº <b>–ú–µ–Ω–µ–¥–∂–µ—Ä –ø–æ –ø—Ä–æ–¥–∞–∂–∞–º</b>
üè¢ <b>–ö–æ–º–ø–∞–Ω–∏—è:</b> –û–û–û "–ü—Ä–∏–º–µ—Ä"
üí∞ <b>–ó–∞—Ä–ø–ª–∞—Ç–∞:</b> –æ—Ç 1000 BYN
üìã <b>–¢—Ä–µ–±–æ–≤–∞–Ω–∏—è:</b> –û–ø—ã—Ç —Ä–∞–±–æ—Ç—ã –æ—Ç 1 –≥–æ–¥–∞, –∫–æ–º–º—É–Ω–∏–∫–∞–±–µ–ª—å–Ω–æ—Å—Ç—å
üìû <b>–ö–æ–Ω—Ç–∞–∫—Ç—ã:</b> @username –∏–ª–∏ +375291234567

–ï—Å–ª–∏ —Å–æ–æ–±—â–µ–Ω–∏–µ –Ω–µ —Å–æ–¥–µ—Ä–∂–∏—Ç –≤–∞–∫–∞–Ω—Å–∏—é, –æ—Ç–≤–µ—Ç—å: "–ù–µ –≤–∞–∫–∞–Ω—Å–∏—è"`
        },
        {
          role: 'user',
          content: text
        }
      ],
      temperature: 0.7,
    });

    const result = response.choices[0].message.content || "–ù–µ –≤–∞–∫–∞–Ω—Å–∏—è";
    console.log(`ü§ñ OpenAI –æ—Ç–≤–µ—Ç–∏–ª:`, result);
    return result;
  } catch (error) {
    console.error(`‚ùå –û—à–∏–±–∫–∞ OpenAI:`, error);
    return "–ù–µ –≤–∞–∫–∞–Ω—Å–∏—è";
  }
}